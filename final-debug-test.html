<!DOCTYPE html>
<html>
<head>
    <title>Final Auto-Logout Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Final Auto-Logout Debug Test</h1>
    <button onclick="runTest()">Run Complete Test</button>
    <div id="results"></div>

    <script>
        async function runTest() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Running comprehensive test...</p>';
            
            let output = '';
            
            function log(message, type = 'info') {
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                output += `<p class="${className}">${message}</p>`;
                results.innerHTML = output;
                console.log(message);
            }
            
            try {
                // Test 1: Database direct query
                log('=== TEST 1: Database Direct Query ===');
                const { supabase } = await import('./lib/supabase.js');
                
                const { data: dbData, error: dbError } = await supabase
                    .from('system_settings')
                    .select('key, value, data_type')
                    .eq('key', 'auto_logout_delay_seconds');
                
                if (dbError) {
                    log(`‚ùå Database error: ${dbError.message}`, 'error');
                } else if (!dbData || dbData.length === 0) {
                    log('‚ùå No auto_logout_delay_seconds record found in database!', 'error');
                } else {
                    const dbSeconds = parseInt(dbData[0].value);
                    const dbMinutes = dbSeconds / 60;
                    log(`‚úÖ Database: ${dbSeconds} seconds = ${dbMinutes} minutes`, 'success');
                    
                    if (dbMinutes !== 2) {
                        log(`‚ùå Database value is wrong! Expected 2 minutes (120 seconds), got ${dbMinutes} minutes (${dbSeconds} seconds)`, 'error');
                    }
                }
                
                // Test 2: System Settings Module
                log('=== TEST 2: System Settings Module ===');
                const { getSystemSettings, clearSettingsCache } = await import('./lib/system-settings.js');
                
                // Clear cache
                clearSettingsCache();
                log('üóëÔ∏è Cache cleared');
                
                const settings = await getSystemSettings(true);
                log(`System settings auto_logout_delay_minutes: ${settings.auto_logout_delay_minutes}`);
                
                if (settings.auto_logout_delay_minutes === 999) {
                    log('‚ùå USING DEFAULT SETTINGS! Database query failed!', 'error');
                } else if (settings.auto_logout_delay_minutes === 2) {
                    log('‚úÖ System settings has correct 2 minutes', 'success');
                } else {
                    log(`‚ùå System settings wrong: ${settings.auto_logout_delay_minutes} minutes, should be 2`, 'error');
                }
                
                // Test 3: Context State
                log('=== TEST 3: Context State ===');
                if (window.debugAutoLogout) {
                    const contextSettings = window.debugAutoLogout.getCurrentSettings();
                    log(`Context delayMinutes: ${contextSettings.delayMinutes}`);
                    
                    if (contextSettings.delayMinutes === 2) {
                        log('‚úÖ Context has correct 2 minutes', 'success');
                    } else {
                        log(`‚ùå Context wrong: ${contextSettings.delayMinutes} minutes, should be 2`, 'error');
                    }
                    
                    // Force reload context
                    log('üîÑ Force reloading context settings...');
                    await window.debugAutoLogout.forceReloadSettings();
                    
                    const newContextSettings = window.debugAutoLogout.getCurrentSettings();
                    log(`Context after reload: ${newContextSettings.delayMinutes} minutes`);
                    
                    if (newContextSettings.delayMinutes === 2) {
                        log('‚úÖ Context after reload has correct 2 minutes', 'success');
                    } else {
                        log(`‚ùå Context after reload wrong: ${newContextSettings.delayMinutes} minutes, should be 2`, 'error');
                    }
                } else {
                    log('‚ùå debugAutoLogout not available', 'error');
                }
                
                // Test 4: Timer Test
                log('=== TEST 4: Timer Test ===');
                if (window.debugAutoLogout) {
                    const beforeReset = window.debugAutoLogout.getCurrentSettings();
                    log(`Before timer reset: ${beforeReset.delayMinutes} minutes, hasTimer: ${beforeReset.hasActiveTimer}`);
                    
                    window.debugAutoLogout.resetTimer();
                    
                    const afterReset = window.debugAutoLogout.getCurrentSettings();
                    log(`After timer reset: ${afterReset.delayMinutes} minutes, hasTimer: ${afterReset.hasActiveTimer}`);
                    
                    if (afterReset.delayMinutes === 2 && afterReset.hasActiveTimer) {
                        log('‚úÖ Timer set correctly for 2 minutes', 'success');
                        log('‚è∞ Auto-logout should happen in exactly 2 minutes from now', 'warning');
                    } else {
                        log(`‚ùå Timer problem: ${afterReset.delayMinutes} minutes, hasTimer: ${afterReset.hasActiveTimer}`, 'error');
                    }
                }
                
                // Summary
                log('=== SUMMARY ===');
                log('If all tests show 2 minutes but logout still happens at 1 minute:');
                log('1. Check browser console for timer messages');
                log('2. Look for "Setting inactivity timer for X minutes"');
                log('3. Check if multiple timers are being created');
                log('4. Verify no other code is calling performAutoLogout()');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
    </script>
</body>
</html>